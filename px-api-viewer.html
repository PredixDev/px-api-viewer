<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-doc-viewer/iron-doc-viewer.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="../iron-doc-viewer/default-theme.html">
<link rel="import" href="../px-theme/px-theme-styles.html"/>
<link rel="import" href="css/px-api-viewer-styles.html"/>

<!--
Element providing API documentation for a requested Polymer component

##### Usage

    <px-api-viewer source="demo_component"></px-api-viewer>

### Styling
The following custom properties are available for styling. Use them with the default tooltip-style property (omit it, or use value "dark").

Custom property | Description
----------------|-------------
`--px-tooltip-text-color` | Text color for the tooltip
`--px-tooltip-background-color` | Background color for the tooltip

@element px-api-viewer
@blurb Element providing API documentation for a requested Polymer component
@homepage index.html
@demo demo.html
-->
<dom-module id="px-api-viewer">
  <template>
    <iron-ajax
        auto
        url="[[_getAPIUrl(source)]]"
        handle-as="json"
        on-response="_handleResponse">
    </iron-ajax>
    <style include="iron-doc-default-theme"></style>
    <style include="px-api-viewer-styles"></style>
    <style include="px-theme-styles"></style>
    <iron-doc-viewer descriptor="[[_elementDescriptor]]"></iron-doc-viewer>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-api-viewer',

    /**
     * Properties block, expose attribute values to the DOM via 'notify'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /*
      * A json object, created by hydrolysis, which contains the actual
      * documentation for the component
      *
      * @property _elementDescriptor
      * @type Object
      */
      _elementDescriptor: {
        type: Object,
        notify: true
      },
      /*
      * A string holding the name of the component.
      * do not add `.html` to this attribute.
      *
      * @property source
      * @type String
      */
      source: {
        type: String,
        value: '',
        notify: true
      },
      /**
       * An array which contains the names of properties/methods/events which will be removed
       * from the hydrolysis object
       * @type {Array}
       */
      hide: {
        type: Array,
        value: function() {
          return [];
        }
      },
      /**
       * An array which contains the names of properties which will be marked
       * as private
       * @type {Array}
       */
      markPrivate: {
        type: Array,
        value: function() {
          return [];
        }
      },
      /**
       * An array which contains the names of properties which will be marked
       * as readonly
       * @type {Array}
       */
      markReadOnly: {
        type: Array,
        value: function() {
          return [];
        }
      },
      /**
       * an array which contains the names and new descriptions of
       * properties we want to change the deccription of.
       * @type {Array}
       */
      changeDescription: {
        type: Array,
        value: function() {
          return [];
        }
      }
    },
    /**
     * find the passed item in either the elements or behaviors arrays in the analyzer obj
     */
    _cleanAPIDocs: function() {
      var categories = ['methods', 'properties'],
          thisElement = this._elementDescriptor['elements'].find(function(eleAPI){
            return (eleAPI.tagname === this.source);
          }, this);

      categories.forEach(function(apiClass){
        var elementAPICollection = thisElement[apiClass];
        elementAPICollection = this._hideAPI(elementAPICollection);
        elementAPICollection = this._changeDescription(elementAPICollection);
        elementAPICollection.forEach(function(apiItem){
          this._markReadOnly(apiItem);
          this._markPrivate(apiItem);
        }, this);

      thisElement[apiClass] = elementAPICollection;
      }, this);

      return thisElement;
    },
    /**
    *
    * This method filters/removes any properties passed into using the hide attribute, by filtering out
    * any matches between the
    * @method _hideAPI
    */
    _hideAPI: function(inputSetToFilter) {
      var propertiesToMutate = [];
      //hide is a special case, since it involves removal of the item,
      //which messes up indexes. so, instead, we filter anything that needs hiding - effectively
      //removing the items this way.
      propertiesToMutate = inputSetToFilter.filter(function(currentProperty) {
        return this.hide.indexOf(currentProperty.name) === -1;
      }.bind(this));

      return propertiesToMutate;
    },
    _markPrivate: function(property) {
      if (this.markPrivate.indexOf(property.name) !== -1){
        property.privacy = 'protected';
      }

    },
    _markReadOnly: function(property) {
      if (this.markReadOnly.indexOf(property.name) !== -1){
        property.metadata.polymer.readOnly = true;
      }
    },
    _changeDescription: function(inputSetToChange) {
      this.changeDescription.forEach(function(propertyToChange){
        var itemToUpdate = inputSetToChange.find(function(property){
          return propertyToChange.name === property.name;
        });
        if (itemToUpdate) {
          itemToUpdate.description = propertyToChange.desc;
        }
      });
      return inputSetToChange;
    },
    _handleResponse: function(val){
      var eleDescriptor = val.target.lastResponse;
      this._elementDescriptor = eleDescriptor;
      this._cleanAPIDocs();
      this.set('_elementDescriptor', eleDescriptor );
      this.fire('pxElementAPIReceived', eleDescriptor[15]);
    },
    _getAPIUrl: function(){
      var parentFolder = this.importPath.substr(0, this.importPath.indexOf(this.tagName.toLowerCase()))
      return parentFolder + this.source + '/' + this.source + '-api.json';
    }
  });
</script>
